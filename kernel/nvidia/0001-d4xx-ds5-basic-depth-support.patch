From 1de9ea041519a3734799278e966fd7b3ce986b47 Mon Sep 17 00:00:00 2001
From: Alex Gantman <alexander.gantman@intel.com>
Date: Tue, 10 Sep 2019 11:44:49 +0300
Subject: [PATCH] d4xx: ds5 basic depth support

Signed-off-by: Alex Gantman <alexander.gantman@intel.com>
---
 drivers/media/platform/tegra/camera/camera_common.c  | 12 ++++++++++++
 drivers/media/platform/tegra/camera/sensor_common.c  |  4 ++++
 drivers/media/platform/tegra/camera/vi/vi4_formats.h |  6 ++++++
 include/media/tegra_camera_core.h                    |  5 +++++
 include/trace/events/camera_common.h                 |  6 ++++--
 5 files changed, 31 insertions(+), 2 deletions(-)

diff --git a/drivers/media/platform/tegra/camera/camera_common.c b/drivers/media/platform/tegra/camera/camera_common.c
index dd2780f..2713749 100644
--- a/drivers/media/platform/tegra/camera/camera_common.c
+++ b/drivers/media/platform/tegra/camera/camera_common.c
@@ -106,6 +106,18 @@ static const struct camera_common_colorfmt camera_common_color_fmts[] = {
 		V4L2_COLORSPACE_SRGB,
 		V4L2_PIX_FMT_UYVY,
 	},
+
+	{
+		MEDIA_BUS_FMT_UYVY8_1X16,
+		V4L2_COLORSPACE_SRGB,
+		V4L2_PIX_FMT_Z16,
+	},
+	{
+		MEDIA_BUS_FMT_Y8_1X8,
+		V4L2_COLORSPACE_SRGB,
+		V4L2_PIX_FMT_GREY,
+	},
+
 	{
 		MEDIA_BUS_FMT_VYUY8_2X8,
 		V4L2_COLORSPACE_SRGB,
diff --git a/drivers/media/platform/tegra/camera/sensor_common.c b/drivers/media/platform/tegra/camera/sensor_common.c
index 75a3af2..9756e9c 100644
--- a/drivers/media/platform/tegra/camera/sensor_common.c
+++ b/drivers/media/platform/tegra/camera/sensor_common.c
@@ -222,6 +222,10 @@ static int extract_pixel_format(
 		*format = V4L2_PIX_FMT_UYVY;
 	else if (strncmp(pixel_t, "yuv_vyuy16", size) == 0)
 		*format = V4L2_PIX_FMT_VYUY;
+	else if (strncmp(pixel_t, "grey_y8", size) == 0)
+		*format = V4L2_PIX_FMT_GREY;
+	else if (strncmp(pixel_t, "grey_y16", size) == 0)
+		*format = V4L2_PIX_FMT_Z16;
 	else {
 		pr_err("%s: Need to extend format%s\n", __func__, pixel_t);
 		return -EINVAL;
diff --git a/drivers/media/platform/tegra/camera/vi/vi4_formats.h b/drivers/media/platform/tegra/camera/vi/vi4_formats.h
index de33c42..d0bbfa3 100644
--- a/drivers/media/platform/tegra/camera/vi/vi4_formats.h
+++ b/drivers/media/platform/tegra/camera/vi/vi4_formats.h
@@ -87,6 +87,9 @@ static const struct tegra_video_format vi4_video_formats[] = {
 	/* RAW 7: TODO */
 
 	/* RAW 8 */
+	TEGRA_VIDEO_FORMAT(RAW8, 8, Y8_1X8, 1, 1, T_L8,
+				RAW8, GREY, "Greyscale 8"),
+
 	TEGRA_VIDEO_FORMAT(RAW8, 8, SRGGB8_1X8, 1, 1, T_L8,
 				RAW8, SRGGB8, "RGRG.. GBGB.."),
 	TEGRA_VIDEO_FORMAT(RAW8, 8, SGRBG8_1X8, 1, 1, T_L8,
@@ -141,6 +144,9 @@ static const struct tegra_video_format vi4_video_formats[] = {
 				YUV422_8, YUYV, "YUV 4:2:2 YUYV"),
 	TEGRA_VIDEO_FORMAT(YUV422, 16, YVYU8_2X8, 2, 1, T_Y8_V8__Y8_U8,
 				YUV422_8, YVYU, "YUV 4:2:2 YVYU"),
+
+	TEGRA_VIDEO_FORMAT(YUV422, 16, UYVY8_1X16, 2, 1, T_R16,
+				USER_2, Z16, "Depth 16"),
 };
 
 #endif
diff --git a/include/media/tegra_camera_core.h b/include/media/tegra_camera_core.h
index 788cf77..fe34b35 100644
--- a/include/media/tegra_camera_core.h
+++ b/include/media/tegra_camera_core.h
@@ -56,6 +56,11 @@ enum tegra_image_dt {
 	TEGRA_IMAGE_DT_RAW10,
 	TEGRA_IMAGE_DT_RAW12,
 	TEGRA_IMAGE_DT_RAW14,
+
+	TEGRA_IMAGE_DT_USER_1 = 48,
+	TEGRA_IMAGE_DT_USER_2,
+	TEGRA_IMAGE_DT_USER_3,
+	TEGRA_IMAGE_DT_USER_4,
 };
 
 /* Supported CSI to VI Data Formats */
diff --git a/include/trace/events/camera_common.h b/include/trace/events/camera_common.h
index 8a16593..7d0a41d 100644
--- a/include/trace/events/camera_common.h
+++ b/include/trace/events/camera_common.h
@@ -98,16 +98,18 @@ TRACE_EVENT(tegra_channel_capture_setup,
 		__field(unsigned int,	width)
 		__field(unsigned int,	height)
 		__field(unsigned int,	format)
+		__field(unsigned int,	img_dt)
 	),
 	TP_fast_assign(
 		__entry->vnc_id = chan->vnc_id[index];
 		__entry->width = chan->format.width;
 		__entry->height = chan->format.height;
 		__entry->format = chan->fmtinfo->img_fmt;
+		__entry->img_dt = chan->fmtinfo->img_dt
 	),
-	TP_printk("vnc_id %u W %u H %u fmt %x",
+	TP_printk("vnc_id %u W %u H %u fmt %x DT %x",
 		  __entry->vnc_id, __entry->width, __entry->height,
-		  __entry->format)
+		  __entry->format, __entry->img_dt)
 );
 
 DECLARE_EVENT_CLASS(frame,
-- 
2.7.4

